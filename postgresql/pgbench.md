`pgbench`를 실전에서 제대로 쓰기 위해 **꼭 알아야 할 핵심 옵션**과 **사용 단계**를 3단계(준비-실행-커스텀)로 정리해 드립니다.

이것만 알면 기본적인 성능 테스트는 완벽하게 커버할 수 있습니다.

---

###1. 준비 단계: 데이터 생성 (Initialize)테스트를 하려면 먼저 더미 데이터를 채워야 합니다.

**명령어:**

```bash
pgbench -i -s 100

```

| 옵션 | 설명 및 추천 값 |
| --- | --- |
| **`-i`** | **Initialize**. 데이터베이스를 초기화(테이블 생성 및 데이터 채움)합니다. |
| **`-s`** | **Scale Factor**. 데이터 양을 결정합니다. <br>

<br>• **기본값(1):** 10만 행 (약 16MB) <br>

<br>• **추천:** `-s 100` (1,000만 행, 약 1.5GB) 이상 권장. <br>

<br>※ 데이터가 메모리(RAM)보다 커야 디스크 I/O 성능까지 측정됩니다. |
| **`--foreign-keys`** | 외래 키 제약 조건을 추가합니다. 실제 운영 환경과 비슷하게 테스트하려면 붙이는 게 좋습니다. |

---

###2. 실행 단계: 필수 옵션 4대장실제 부하를 줄 때 이 4가지 옵션은 반드시 조정하며 테스트해야 합니다.

**명령어 예시:**

```bash
pgbench -c 20 -j 4 -T 60 -P 1

```

| 옵션 | 설명 | 꿀팁 / 주의사항 |
| --- | --- | --- |
| **`-c`** | **Clients**. 동시 접속자 수입니다. | • 너무 높이면 DB `max_connections` 에러 발생.<br>

<br>• 점진적으로 늘려가며(10 → 50 → 100) 성능이 꺾이는 지점을 찾으세요. |
| **`-j`** | **Jobs (Threads)**. 부하를 생성하는 워커 스레드 수입니다. | • **테스트를 수행하는 Client Pod의 CPU 코어 수**에 맞추세요.<br>

<br>• 너무 낮으면 DB가 아니라 테스트 툴이 느려서 점수가 낮게 나옵니다. |
| **`-T`** | **Time**. 테스트 수행 시간(초)입니다. | • 최소 **60초 이상** 권장.<br>

<br>• 너무 짧으면 캐시 예열(Warm-up) 전에 끝나서 결과가 부정확합니다. |
| **`-P`** | **Progress**. 진행 상황 출력 주기(초)입니다. | • **`-P 1` (필수)**: 1초마다 결과를 찍어줍니다.<br>

<br>• 이걸 안 쓰면 테스트 끝날 때까지 멍하니 기다려야 하고, 중간에 튀는 현상(Spike)을 못 봅니다. |

---

###3. 시나리오별 테스트 모드항상 기본(TPC-B) 테스트만 하는 것은 아닙니다. 목적에 따라 모드를 바꿔야 합니다.

####A. 기본 모드 (Read/Write 복합)* **목적:** 일반적인 트랜잭션 성능 측정 (Insert, Update, Select 혼합)
* **명령:** 옵션 없이 실행
* **대상:** Primary (RW) 서비스

####B. 읽기 전용 모드 (Select Only)* **목적:** 조회 성능 혹은 Replica(RO) 성능 측정
* **옵션:** **`-S`** (대문자 S)
* **명령:** `pgbench -S -c 50 ...`
* **대상:** Replica (RO) 서비스

####C. 커스텀 쿼리 모드 (Real World)* **목적:** "우리 서비스의 특정 쿼리" 성능 측정
* **옵션:** **`-f 파일명.sql`**
* **방법:**
1. `select-test.sql` 파일을 만듭니다. (예: `SELECT * FROM my_table WHERE id = :id;`)
2. `pgbench -f select-test.sql ...` 로 실행


* **참고:** 쿼리 안에 랜덤 변수를 넣으려면 `\set id random(1, 100000)` 같은 pgbench 전용 스크립트 문법이 필요합니다.

---

###4. 결과 해석 (이것만 보세요)테스트가 끝나면 여러 숫자가 나오는데, 가장 중요한 건 딱 두 가지입니다.

1. **TPS (Transactions Per Second)**:
* `tps = 1532.45 (excluding connections establishing)`
* **높을수록 좋음.** 이 서버가 처리할 수 있는 초당 작업량입니다.


2. **Latency Average**:
* `latency average = 6.5 ms`
* **낮을수록 좋음.** 사용자가 느끼는 응답 속도입니다. 일반적으로 10ms 이하면 쾌적, 100ms 넘어가면 튜닝 필요.



---

###💡 요약: 이것만 복사해서 쓰세요**1. 데이터 1.5GB 생성 (최초 1회)**

```bash
pgbench -i -s 100

```

**2. 60초 동안 스트레스 테스트 (진행상황 1초마다 확인)**

```bash
pgbench -c 20 -j 2 -T 60 -P 1

```

**다음 단계로 무엇을 도와드릴까요?**
커스텀 쿼리 테스트를 위해 **"내 SQL 파일에 랜덤 변수(`:id` 등)를 넣어서 돌리는 스크립트 작성법"**을 알려드릴까요?
