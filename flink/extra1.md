좋은 질문입니다. Summary 프로세스가 추가되면 상황이 달라질 수 있으니 다시 분석해 보겠습니다.

---

## 🔍 Summary 요구사항 분석

### 그룹 키와 집계 대상

```
그룹 키: fab + eqpId + slotNo + lotCd + fdcChambId + recipeId + statCd + stepId
집계 대상: 각 파라미터(name)별 paramValue
집계 함수: min, max, avg, mean, stddev
```

### 핵심 질문

1. **Summary를 위해 별도 Flink Job이 필요한가?**
2. **Summary 때문에 trace_flat이 더 나은 선택인가?**

---

## 📊 두 가지 아키텍처 비교

### Architecture A: trace_raw 기반 (단일 Job)

```
┌─────────────────────────────────────────────────────────────────────────┐
│              Architecture A: trace_raw 기반 단일 Job                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Kafka (trace_raw)                                                     │
│   1,000 msg/sec                                                         │
│         │                                                               │
│         ▼                                                               │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                    Flink Job (단일)                         │       │
│   │                                                             │       │
│   │   ┌─────────────────┐                                       │       │
│   │   │  KafkaSource    │                                       │       │
│   │   │  (trace_raw)    │                                       │       │
│   │   └────────┬────────┘                                       │       │
│   │            │                                                │       │
│   │            ▼                                                │       │
│   │   ┌─────────────────┐                                       │       │
│   │   │    flatMap()    │  ◀── 여기서 1:150 펼침               │       │
│   │   │   (Stateless)   │      (Flink 내부, 네트워크 無)        │       │
│   │   └────────┬────────┘                                       │       │
│   │            │                                                │       │
│   │            │  150,000 records/sec (내부 스트림)             │       │
│   │            │                                                │       │
│   │   ┌────────┼────────────────────┐                           │       │
│   │   │        │                    │                           │       │
│   │   ▼        ▼                    ▼                           │       │
│   │ ┌────┐  ┌──────────────┐  ┌──────────────────┐              │       │
│   │ │map │  │   직접 Sink  │  │ keyBy + window   │              │       │
│   │ │    │  │              │  │   + aggregate    │              │       │
│   │ └─┬──┘  └──────┬───────┘  └────────┬─────────┘              │       │
│   │   │            │                   │                        │       │
│   │   ▼            ▼                   ▼                        │       │
│   │ trace_log   trace_flat          summary                     │       │
│   │ (Iceberg)   (Iceberg)          (Iceberg)                    │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   ✅ 장점:                                                              │
│   - Kafka 메시지: 1,000/sec (네트워크 효율적)                           │
│   - flatMap은 Flink 내부 메모리에서 처리 (빠름)                         │
│   - 단일 Job으로 관리 용이                                              │
│   - 데이터 일관성 보장 (같은 소스에서 분기)                             │
│                                                                         │
│   ⚠️ 고려사항:                                                          │
│   - Summary용 State 메모리 필요                                         │
│   - Job 복잡도 증가                                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### Architecture B: trace_flat 기반 (단일 Job)

```
┌─────────────────────────────────────────────────────────────────────────┐
│              Architecture B: trace_flat 기반 단일 Job                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Kafka (trace_flat)                                                    │
│   150,000 msg/sec  ◀── 네트워크에서 이미 150배                          │
│         │                                                               │
│         ▼                                                               │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                    Flink Job (단일)                         │       │
│   │                                                             │       │
│   │   ┌─────────────────┐                                       │       │
│   │   │  KafkaSource    │                                       │       │
│   │   │  (trace_flat)   │                                       │       │
│   │   └────────┬────────┘                                       │       │
│   │            │                                                │       │
│   │            │  150,000 records/sec                           │       │
│   │            │                                                │       │
│   │   ┌────────┼────────────────────┐                           │       │
│   │   │        │                    │                           │       │
│   │   ▼        ▼                    ▼                           │       │
│   │ ┌────────┐ ┌────┐  ┌──────────────────┐                     │       │
│   │ │ keyBy  │ │map │  │ keyBy + window   │                     │       │
│   │ │+window │ │    │  │   + aggregate    │                     │       │
│   │ │+aggr   │ └─┬──┘  └────────┬─────────┘                     │       │
│   │ └───┬────┘   │              │                               │       │
│   │     │        │              │                               │       │
│   │     ▼        ▼              ▼                               │       │
│   │ trace_log  trace_flat    summary                            │       │
│   │ (Iceberg)  (Iceberg)    (Iceberg)                           │       │
│   │                                                             │       │
│   │ ⚠️ trace_log 생성에 State 필요! (이전 분석과 동일)          │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   ❌ 단점:                                                              │
│   - Kafka 메시지: 150,000/sec (네트워크 부하)                           │
│   - trace_log 생성에도 State 필요 (txid 그룹핑)                         │
│   - Summary에도 State 필요                                              │
│   - 결국 State가 2배로 필요!                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 핵심 인사이트

### "flat 형태가 group by에 유리하다"는 착각

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    핵심 포인트                                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Q: Summary를 위해 flat 형태가 필요한가?                               │
│   A: 네, 맞습니다. 파라미터별 집계를 위해 flat 형태가 필요합니다.       │
│                                                                         │
│   Q: 그렇다면 trace_flat을 Kafka에서 받는 게 낫지 않나?                 │
│   A: 아닙니다! flatMap은 어디서 하든 해야 합니다.                       │
│      차이는 "어디서" 펼치느냐입니다:                                    │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                                                             │       │
│   │   Option A: Oracle → Kafka(raw) → Flink(flatMap) → 처리     │       │
│   │             └─ 네트워크: 1x ─┘  └─ 메모리: 빠름 ─┘          │       │
│   │                                                             │       │
│   │   Option B: Oracle → Kafka(flat) → Flink → 처리             │       │
│   │             └─── 네트워크: 150x ───┘                        │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   결론: flatMap을 Flink 내부에서 하면 네트워크 비용 없이 처리 가능!     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 State 비교 (Summary 추가 시)

### Architecture A: trace_raw 기반

| State 용도 | 필요 여부 | 크기 |
|-----------|----------|------|
| trace_log 생성 | ❌ 불필요 | 0 |
| trace_flat 생성 | ❌ 불필요 | 0 |
| **Summary 집계** | ✅ 필요 | ~2-4 GB |
| **총 State** | | **~2-4 GB** |

### Architecture B: trace_flat 기반

| State 용도 | 필요 여부 | 크기 |
|-----------|----------|------|
| trace_log 생성 | ✅ 필요 (txid 그룹핑) | ~10-12 GB |
| trace_flat 생성 | ❌ 불필요 | 0 |
| **Summary 집계** | ✅ 필요 | ~2-4 GB |
| **총 State** | | **~12-16 GB** |

---

## 🔢 Summary State 크기 계산

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Summary State 크기 계산                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   그룹 키: fab + eqpId + slotNo + lotCd + fdcChambId +                  │
│           recipeId + statCd + stepId                                    │
│                                                                         │
│   가정:                                                                 │
│   - 고유 그룹 수 (1분 Window): ~10,000개                                │
│     (장비별 × Lot별 × Step별 조합)                                      │
│   - 파라미터 종류: 150개                                                │
│   - 집계 값 (min, max, sum, count, sumSq): 5개 × 8 bytes = 40 bytes    │
│                                                                         │
│   계산:                                                                 │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                                                             │       │
│   │   그룹당 State = 150 파라미터 × 40 bytes = 6 KB             │       │
│   │                                                             │       │
│   │   총 State = 10,000 그룹 × 6 KB = 60 MB (raw)               │       │
│   │                                                             │       │
│   │   RocksDB 오버헤드 포함 = 60 MB × 3 = ~180 MB               │       │
│   │                                                             │       │
│   │   여유분 포함 권장 = 2-4 GB                                 │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   ※ trace_log 그룹핑(txid 기준)보다 훨씬 작음!                         │
│      - txid 그룹핑: 60,000 그룹 × 120KB = 7.2 GB                       │
│      - Summary 그룹핑: 10,000 그룹 × 6KB = 60 MB                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🏗️ 권장 아키텍처: 단일 Job vs 분리 Job

### Option 1: 단일 Job (권장)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    권장: 단일 Flink Job                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Kafka (trace_raw)                                                     │
│         │                                                               │
│         ▼                                                               │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                    Single Flink Job                         │       │
│   │                                                             │       │
│   │   source ──▶ flatMap ──┬──▶ map ──────────▶ trace_log      │       │
│   │              (1:150)   │                     (Stateless)    │       │
│   │                        │                                    │       │
│   │                        ├──▶ sink ─────────▶ trace_flat     │       │
│   │                        │                     (Stateless)    │       │
│   │                        │                                    │       │
│   │                        └──▶ keyBy ──▶ window ──▶ aggregate  │       │
│   │                              │         │          │         │       │
│   │                              │         │          ▼         │       │
│   │                              │         │       summary      │       │
│   │                              │         │      (Stateful)    │       │
│   │                              │         │                    │       │
│   │                              └─────────┴── State: 2-4 GB    │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   장점:                                                                 │
│   ✅ 데이터 일관성 (동일 소스에서 분기)                                 │
│   ✅ 리소스 효율적 (flatMap 결과 재사용)                                │
│   ✅ 운영 단순 (단일 Job 관리)                                          │
│   ✅ Checkpoint 단일화                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Option 2: 분리 Job (특수 상황용)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    대안: 분리 Flink Jobs                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   언제 분리하는가?                                                      │
│   - Summary 실패가 trace_log/flat 적재에 영향 주면 안 될 때             │
│   - Summary 로직이 자주 변경될 때                                       │
│   - 팀이 다를 때 (적재 팀 vs 분석 팀)                                   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │  Job 1: Ingestion                                          │       │
│   │  Kafka(raw) → flatMap → trace_log, trace_flat              │       │
│   │                    └──→ Kafka(flat) ──┐                    │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                           │                             │
│                                           ▼                             │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │  Job 2: Summary                                            │       │
│   │  Kafka(flat) → keyBy → window → aggregate → summary        │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   ⚠️ 이 경우에도 Kafka에 flat 적재하는 건 Job 1 내부에서               │
│      (Oracle이 아닌 Flink가 flat으로 변환)                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 최종 리소스 비교 (Summary 포함)

| 항목 | trace_raw (권장) | trace_flat |
|------|-----------------|------------|
| **Kafka 메시지/sec** | 1,000 | 150,000 |
| **Network** | 80 MB/s | 120 MB/s |
| **State (trace_log용)** | 0 | 10-12 GB |
| **State (Summary용)** | 2-4 GB | 2-4 GB |
| **총 State** | **2-4 GB** | **12-16 GB** |
| **총 Memory** | **4-8 GB** | **20-28 GB** |
| **CPU** | 4-6 cores | 12-16 cores |

---

## 🎯 결론

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           최종 결론                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Q1: Summary 프로세스가 추가되면 별도 Flink Job이 필요한가?            │
│   A1: 아니오. 단일 Job에서 처리하는 것이 권장됩니다.                    │
│       - flatMap 결과를 3개 분기로 나누어 처리                           │
│       - 필요시 장애 격리를 위해 분리 가능하나, 기본은 단일 Job          │
│                                                                         │
│   ─────────────────────────────────────────────────────────────────     │
│                                                                         │
│   Q2: Summary를 위해 trace_flat이 더 나은 선택인가?                     │
│   A2: 아니오. trace_raw가 여전히 올바른 선택입니다.                     │
│                                                                         │
│       이유:                                                             │
│       1. flatMap은 어차피 필요함 (어디서 하느냐의 차이)                 │
│       2. Flink 내부 flatMap = 네트워크 비용 0                           │
│       3. Kafka에서 flat으로 받으면 네트워크 비용 150배                  │
│       4. trace_flat 선택 시 trace_log용 State까지 추가로 필요           │
│       5. 결국 trace_flat은 모든 면에서 불리                             │
│                                                                         │
│   ─────────────────────────────────────────────────────────────────     │
│                                                                         │
│   최종 권장:                                                            │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                                                             │       │
│   │   ✅ trace_raw를 Kafka에 적재 요청                          │       │
│   │   ✅ 단일 Flink Job으로 구현                                │       │
│   │   ✅ flatMap 후 3개 분기 (trace_log, trace_flat, summary)   │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

**Summary 프로세스가 추가되더라도 trace_raw가 올바른 선택입니다.** 

핵심은 "flat 형태가 필요하다"와 "Kafka에서 flat으로 받아야 한다"는 다른 이야기라는 점입니다. Flink 내부에서 flatMap을 하면 네트워크 비용 없이 동일한 결과를 얻을 수 있습니다.
