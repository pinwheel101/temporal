좋은 질문입니다. 두 방식을 비교해 드릴게요.

---

## 🔀 두 가지 방식 비교

### 방식 A: trace_raw에 필드 추가

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    방식 A: 필드 추가                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   trace_raw 메시지 예시:                                                │
│   {                                                                     │
│     "txid": "...",                                                      │
│     "eventTime": "...",                                                 │
│     "stepId": "4",                                                      │
│     "substId": "TE2ZL69_09",                                            │
│     "parameterList": [...],                                             │
│     "context": {...},                                                   │
│                                                                         │
│     // 추가 필드                                                        │
│     "stepEventType": "RUNNING",  // "START" | "RUNNING" | "END" | null  │
│     "waferEventType": "RUNNING"  // "START" | "RUNNING" | "END" | null  │
│   }                                                                     │
│                                                                         │
│   Kafka:                                                                │
│   ┌────────────────────────────────┐                                    │
│   │       Topic: trace_raw         │                                    │
│   │  (데이터 + 이벤트 정보 통합)   │                                    │
│   └────────────────────────────────┘                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 방식 B: 별도 토픽 분리

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    방식 B: 별도 토픽                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   이벤트 메시지 예시:                                                   │
│   {                                                                     │
│     "eventType": "STEP_START",  // STEP_START, STEP_END,               │
│     "fab": "M16",               // WAFER_START, WAFER_END              │
│     "eqpId": "6DGP4212",                                                │
│     "fdcChambId": "6DGP4212_PM1",                                       │
│     "lotId": "TE2ZL69",                                                 │
│     "stepId": "4",                                                      │
│     "substId": "TE2ZL69_09",                                            │
│     "eventTime": "2026-01-13 12:31:18.000"                              │
│   }                                                                     │
│                                                                         │
│   Kafka:                                                                │
│   ┌────────────────────┐    ┌────────────────────┐                      │
│   │  Topic: trace_raw  │    │  Topic: events     │                      │
│   │  (데이터만)        │    │  (이벤트만)        │                      │
│   └────────────────────┘    └────────────────────┘                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 상세 비교

| 항목 | 방식 A: 필드 추가 | 방식 B: 별도 토픽 |
|------|------------------|------------------|
| **Kafka 토픽 수** | 1개 | 2개 |
| **메시지 정렬** | ✅ 자동 보장 (같은 토픽) | ⚠️ 별도 처리 필요 |
| **Flink 구현** | 단순 (단일 Source) | 복잡 (connect + CoProcess) |
| **Oracle 팀 작업** | 기존 발행 로직 수정 | 새 발행 로직 추가 |
| **이벤트 누락 시 영향** | 필드가 null일 뿐 | 메시지 자체가 없음 |
| **독립적 스케일링** | ❌ 불가 | ✅ 가능 |
| **다른 시스템 재사용** | ❌ trace_raw 전체 소비 필요 | ✅ 이벤트만 소비 가능 |

---

## 🎯 핵심 차이점

### 1. 시간 정렬 문제

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    시간 정렬 문제                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   방식 A (필드 추가):                                                   │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │  trace_raw 토픽                                             │       │
│   │  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐                 │       │
│   │  │ 1 │ │ 2 │ │ 3 │ │ 4 │ │ 5 │ │ 6 │ │ 7 │                 │       │
│   │  │   │ │ S │ │   │ │   │ │   │ │ E │ │   │                 │       │
│   │  └───┘ └───┘ └───┘ └───┘ └───┘ └───┘ └───┘                 │       │
│   │        START              END                               │       │
│   │                                                             │       │
│   │  ✅ 순서 자동 보장                                          │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│   방식 B (별도 토픽):                                                   │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │  trace_raw 토픽          events 토픽                        │       │
│   │  ┌───┐ ┌───┐ ┌───┐      ┌───┐     ┌───┐                     │       │
│   │  │ 1 │ │ 2 │ │ 3 │      │ S │     │ E │                     │       │
│   │  └───┘ └───┘ └───┘      └───┘     └───┘                     │       │
│   │                          │         │                        │       │
│   │  ⚠️ 순서 보장 안됨       │         │                        │       │
│   │  - START가 데이터보다 늦게 도착할 수 있음                   │       │
│   │  - END가 먼저 도착할 수 있음                                │       │
│   │  - Watermark 기반 정렬 필요                                 │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2. Flink 구현 복잡도

```java
// 방식 A: 단순
DataStream<TraceRaw> source = env.fromSource(kafkaTraceRaw, ...);

source.flatMap(...)
      .keyBy(...)
      .process(new SummaryFunction());  // 필드 체크만 하면 됨


// 방식 B: 복잡
DataStream<TraceRaw> traceSource = env.fromSource(kafkaTraceRaw, ...);
DataStream<Event> eventSource = env.fromSource(kafkaEvents, ...);

traceSource.flatMap(...)
           .connect(eventSource)        // 두 스트림 연결
           .keyBy(...)
           .process(new CoProcessFunction<>() {
               // 두 스트림의 이벤트를 각각 처리
               // Watermark 기반 시간 정렬 필요
               // Late event 처리 필요
           });
```

### 3. 이벤트 누락 시 동작

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    이벤트 누락 시 동작 차이                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   방식 A:                                                               │
│   - stepEventType: null 로 수신                                         │
│   - 데이터는 정상 수신됨                                                │
│   - "이벤트 없음"을 명확히 알 수 있음                                   │
│                                                                         │
│   방식 B:                                                               │
│   - 이벤트 메시지 자체가 없음                                           │
│   - "아직 안 온 건지" vs "안 오는 건지" 구분 어려움                     │
│   - Timeout 의존도가 더 높아짐                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## ✅ 결론: 방식 A (필드 추가)가 더 나음

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    권장: 방식 A (필드 추가)                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   이유:                                                                 │
│                                                                         │
│   1. 시간 정렬 자동 보장                                                │
│      - 같은 토픽이므로 파티션 내 순서 보장                              │
│      - 복잡한 Watermark 처리 불필요                                     │
│                                                                         │
│   2. 구현 단순화                                                        │
│      - 단일 Source, 단일 스트림                                         │
│      - connect(), CoProcessFunction 불필요                              │
│                                                                         │
│   3. 누락 감지 용이                                                     │
│      - null 체크로 명확히 판단 가능                                     │
│      - "이벤트가 없다"는 것을 확실히 알 수 있음                         │
│                                                                         │
│   4. 운영 단순화                                                        │
│      - 토픽 1개만 관리                                                  │
│      - Consumer Lag 모니터링 단순                                       │
│                                                                         │
│   ─────────────────────────────────────────────────────────────────     │
│                                                                         │
│   Oracle 팀 요청사항 (수정):                                            │
│   ┌─────────────────────────────────────────────────────────────┐       │
│   │                                                             │       │
│   │   trace_raw에 다음 필드 추가 요청:                          │       │
│   │                                                             │       │
│   │   - stepEventType: "START" | "END" | null                   │       │
│   │   - waferEventType: "START" | "END" | null                  │       │
│   │                                                             │       │
│   │   (이벤트가 아닌 일반 데이터는 null로 발행)                 │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## ⚠️ 방식 B가 더 나은 경우

별도 토픽이 더 나은 상황도 있습니다:

| 상황 | 이유 |
|------|------|
| 이벤트를 **다른 시스템에서도** 사용할 때 | 이벤트만 구독 가능 |
| 이벤트 발행 **주체가 다른 시스템**일 때 | MES, EAP 등 별도 시스템 |
| 이벤트 **발행 주기가 매우 다를** 때 | 독립적 스케일링 필요 |

현재 상황에서는 **방식 A (필드 추가)**가 더 적합합니다.
