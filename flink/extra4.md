ë„¤, ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜¤íˆë ¤ **ë” ë‹¨ìˆœí•´ì§‘ë‹ˆë‹¤.**

---

## âœ… 3ì¤‘ ë°©ì–´ ì „ëµ - í•„ë“œ ì¶”ê°€ ë°©ì‹ ì ìš©

### ë³€ê²½ ì „ (ë³„ë„ í† í”½) vs ë³€ê²½ í›„ (í•„ë“œ ì¶”ê°€)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    êµ¬í˜„ ë³µì¡ë„ ë¹„êµ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   ë³„ë„ í† í”½ ë°©ì‹:                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚                                                             â”‚       â”‚
â”‚   â”‚   traceSource.connect(eventSource)                          â”‚       â”‚
â”‚   â”‚              .keyBy(...)                                    â”‚       â”‚
â”‚   â”‚              .process(new CoProcessFunction<>() {           â”‚       â”‚
â”‚   â”‚                  // processElement1() - trace ë°ì´í„°        â”‚       â”‚
â”‚   â”‚                  // processElement2() - event ë°ì´í„°        â”‚       â”‚
â”‚   â”‚                  // ë‘ ìŠ¤íŠ¸ë¦¼ ì‹œê°„ ì •ë ¬ ì²˜ë¦¬                 â”‚       â”‚
â”‚   â”‚                  // Late event ì²˜ë¦¬                         â”‚       â”‚
â”‚   â”‚              });                                            â”‚       â”‚
â”‚   â”‚                                                             â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                         â”‚
â”‚   í•„ë“œ ì¶”ê°€ ë°©ì‹:                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚                                                             â”‚       â”‚
â”‚   â”‚   traceSource.flatMap(...)                                  â”‚       â”‚
â”‚   â”‚              .keyBy(...)                                    â”‚       â”‚
â”‚   â”‚              .process(new KeyedProcessFunction<>() {        â”‚       â”‚
â”‚   â”‚                  // processElement() - ë‹¨ì¼ ë©”ì„œë“œ          â”‚       â”‚
â”‚   â”‚                  // í•„ë“œ ê°’ ì²´í¬ë¡œ ë¶„ê¸°                      â”‚       â”‚
â”‚   â”‚              });                                            â”‚       â”‚
â”‚   â”‚                                                             â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                         â”‚
â”‚   âœ… connect() ë¶ˆí•„ìš”                                                   â”‚
â”‚   âœ… CoProcessFunction â†’ KeyedProcessFunction (ë” ë‹¨ìˆœ)                 â”‚
â”‚   âœ… ì‹œê°„ ì •ë ¬ ë¡œì§ ë¶ˆí•„ìš”                                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ë‹¨ìˆœí™”ëœ êµ¬í˜„ (Pseudo Code)

```java
public class StepWaferSummaryFunction 
    extends KeyedProcessFunction<String, TraceFlat, StepWaferSummary> {
    
    private ValueState<StepWaferState> state;
    private static final long TIMEOUT_MS = 30 * 60 * 1000;
    
    @Override
    public void processElement(TraceFlat event, Context ctx, 
                               Collector<StepWaferSummary> out) {
        
        StepWaferState current = getOrCreateState();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 3ì¤‘ ë°©ì–´ ì „ëµ (í•„ë“œ ì¶”ê°€ ë°©ì‹)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // 1ï¸âƒ£ ì´ë²¤íŠ¸ ê¸°ë°˜ (Primary) - í•„ë“œ ê°’ ì²´í¬
        if ("START".equals(event.getStepEventType())) {
            handleStepStart(current, event, ctx);
        }
        else if ("END".equals(event.getStepEventType())) {
            handleStepEnd(current, event, ctx, out);  // â†’ Summary ì¶œë ¥
            return;
        }
        
        // 2ï¸âƒ£ ìƒíƒœ ë³€ê²½ ê°ì§€ (Secondary)
        if (isStepChanged(current, event)) {
            // ì´ì „ Stepì˜ Summary ì¶œë ¥ (END ì´ë²¤íŠ¸ ì—†ì´ ë³€ê²½ëœ ê²½ìš°)
            current.warnings.add("MISSING_END_EVENT");
            emitSummary(current, "STATE_CHANGE", out);
            current = resetForNewStep(event);
        }
        
        // 3ï¸âƒ£ Timeout (Fallback) - íƒ€ì´ë¨¸ëŠ” onTimer()ì—ì„œ ì²˜ë¦¬
        
        // ë°ì´í„° ì§‘ê³„
        updateStatistics(current, event);
        registerTimeoutIfNeeded(current, event, ctx);
        
        state.update(current);
    }
    
    @Override
    public void onTimer(long timestamp, OnTimerContext ctx, 
                        Collector<StepWaferSummary> out) {
        // 3ï¸âƒ£ Timeout ë°œë™
        StepWaferState current = state.value();
        if (current != null && current.dataCount > 0) {
            current.warnings.add("TIMEOUT_TRIGGERED");
            if (!current.endEventReceived) {
                current.warnings.add("MISSING_END_EVENT");
            }
            emitSummary(current, "TIMEOUT", out);
            state.clear();
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Helper Methods
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    private void handleStepStart(StepWaferState state, TraceFlat event, Context ctx) {
        state.startEventReceived = true;
        state.startEventTime = event.getEventTimestamp();
        
        // Timeout íƒ€ì´ë¨¸ ë“±ë¡
        ctx.timerService().registerEventTimeTimer(
            event.getEventTimestamp() + TIMEOUT_MS
        );
    }
    
    private void handleStepEnd(StepWaferState state, TraceFlat event,
                               Context ctx, Collector<StepWaferSummary> out) {
        state.endEventReceived = true;
        state.endEventTime = event.getEventTimestamp();
        
        // ì •ìƒ ì™„ë£Œ - Summary ì¶œë ¥
        emitSummary(state, "EVENT", out);
        
        // State í´ë¦¬ì–´
        this.state.clear();
    }
    
    private boolean isStepChanged(StepWaferState state, TraceFlat event) {
        if (state.stepId == null) return false;
        return !state.stepId.equals(event.getStepId());
    }
    
    private void registerTimeoutIfNeeded(StepWaferState state, 
                                         TraceFlat event, Context ctx) {
        // ì‹œì‘ ì´ë²¤íŠ¸ ì—†ì´ ë°ì´í„°ê°€ ë¨¼ì € ì˜¨ ê²½ìš°
        if (!state.startEventReceived && state.firstDataTime == null) {
            state.firstDataTime = event.getEventTimestamp();
            state.warnings.add("MISSING_START_EVENT");
            
            ctx.timerService().registerEventTimeTimer(
                event.getEventTimestamp() + TIMEOUT_MS
            );
        }
    }
}
```

---

## ğŸ“Š 3ì¤‘ ë°©ì–´ ë™ì‘ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    3ì¤‘ ë°©ì–´ ë™ì‘ íë¦„ (í•„ë“œ ì¶”ê°€ ë°©ì‹)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   ì…ë ¥ ë©”ì‹œì§€ ì˜ˆì‹œ:                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ { stepEventType: "START", stepId: "4", ... }                â”‚ â‘     â”‚
â”‚   â”‚ { stepEventType: null,    stepId: "4", paramValue: ... }    â”‚ â‘¡    â”‚
â”‚   â”‚ { stepEventType: null,    stepId: "4", paramValue: ... }    â”‚ â‘¢    â”‚
â”‚   â”‚ { stepEventType: null,    stepId: "4", paramValue: ... }    â”‚ â‘£    â”‚
â”‚   â”‚ { stepEventType: "END",   stepId: "4", ... }                â”‚ â‘¤    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                         â”‚
â”‚   ì²˜ë¦¬ íë¦„:                                                            â”‚
â”‚                                                                         â”‚
â”‚   â‘  stepEventType="START" ê°ì§€                                         â”‚
â”‚      â””â”€â–¶ startEventReceived = true                                     â”‚
â”‚      â””â”€â–¶ Timeout íƒ€ì´ë¨¸ ë“±ë¡ (30ë¶„ í›„)                                  â”‚
â”‚                                                                         â”‚
â”‚   â‘¡â‘¢â‘£ stepEventType=null (ì¼ë°˜ ë°ì´í„°)                                 â”‚
â”‚      â””â”€â–¶ í†µê³„ ì§‘ê³„ (min, max, sum, count, sumSq)                       â”‚
â”‚                                                                         â”‚
â”‚   â‘¤ stepEventType="END" ê°ì§€                                           â”‚
â”‚      â””â”€â–¶ endEventReceived = true                                       â”‚
â”‚      â””â”€â–¶ Summary ì¶œë ¥ (completionType: "EVENT")                        â”‚
â”‚      â””â”€â–¶ State í´ë¦¬ì–´, íƒ€ì´ë¨¸ ì·¨ì†Œ                                      â”‚
â”‚                                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                         â”‚
â”‚   ì´ìƒ ì¼€ì´ìŠ¤ 1: END ì—†ì´ Step ë³€ê²½                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ { stepEventType: "START", stepId: "4", ... }                â”‚       â”‚
â”‚   â”‚ { stepEventType: null,    stepId: "4", paramValue: ... }    â”‚       â”‚
â”‚   â”‚ { stepEventType: "START", stepId: "5", ... }  â—€â”€â”€ Step ë³€ê²½!â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚      â””â”€â–¶ Step 4 Summary ì¶œë ¥ (completionType: "STATE_CHANGE")          â”‚
â”‚      â””â”€â–¶ warnings: ["MISSING_END_EVENT"]                               â”‚
â”‚      â””â”€â–¶ Step 5 ìƒˆë¡œ ì‹œì‘                                              â”‚
â”‚                                                                         â”‚
â”‚   ì´ìƒ ì¼€ì´ìŠ¤ 2: 30ë¶„ê°„ END ì—†ìŒ                                        â”‚
â”‚      â””â”€â–¶ Timeout íƒ€ì´ë¨¸ ë°œë™                                           â”‚
â”‚      â””â”€â–¶ Summary ì¶œë ¥ (completionType: "TIMEOUT")                      â”‚
â”‚      â””â”€â–¶ warnings: ["TIMEOUT_TRIGGERED", "MISSING_END_EVENT"]          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ìš”ì•½

| í•­ëª© | ë³„ë„ í† í”½ ë°©ì‹ | í•„ë“œ ì¶”ê°€ ë°©ì‹ |
|------|---------------|---------------|
| **3ì¤‘ ë°©ì–´ ì „ëµ** | âœ… ì ìš© ê°€ëŠ¥ | âœ… ì ìš© ê°€ëŠ¥ |
| **êµ¬í˜„ ë³µì¡ë„** | ë†’ìŒ (CoProcessFunction) | **ë‚®ìŒ (KeyedProcessFunction)** |
| **ì‹œê°„ ì •ë ¬ ì²˜ë¦¬** | í•„ìš” | **ë¶ˆí•„ìš”** |
| **ì½”ë“œ ë¼ì¸ ìˆ˜** | ë§ìŒ | **ì ìŒ** |
| **ë””ë²„ê¹… ë‚œì´ë„** | ë†’ìŒ | **ë‚®ìŒ** |

**3ì¤‘ ë°©ì–´ ì „ëµì€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë©°, í•„ë“œ ì¶”ê°€ ë°©ì‹ì´ êµ¬í˜„ì´ ë” ë‹¨ìˆœí•©ë‹ˆë‹¤.**
