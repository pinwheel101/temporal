pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  containers:
  # Git ì²´í¬ì•„ì›ƒìš©
  - name: git
    image: nexus.your-company.com:8082/alpine/git:latest
    command:
    - cat
    tty: true
    
  # Kaniko ë¹Œë“œìš©
  - name: kaniko
    image: nexus.your-company.com:8082/kaniko-project/executor:debug
    command:
    - /busybox/cat
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker/
      
  volumes:
  - name: docker-config
    secret:
      secretName: nexus-docker-config
      items:
      - key: .dockerconfigjson
        path: config.json
"""
        }
    }
    
    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: 'ë¹Œë“œí•  ë¸Œëœì¹˜')
        string(name: 'DOCKERFILE_PATH', defaultValue: 'apache/airflow/3.1.1/Dockerfile', description: 'Dockerfile ê²½ë¡œ')
    }
    
    environment {
        NEXUS_REGISTRY = 'nexus.your-company.com:8082'
    }
    
    stages {
        stage('Checkout') {
            steps {
                container('git') {
                    git branch: "${params.BRANCH_NAME}",
                        credentialsId: 'bitbucket-credentials',
                        url: 'https://bitbucket.org/your-org/your-repo.git'
                    
                    sh """
                        echo "âœ… Checked out branch: ${params.BRANCH_NAME}"
                        ls -la ${params.DOCKERFILE_PATH}
                    """
                }
            }
        }
        
        stage('Build and Push') {
            steps {
                container('kaniko') {
                    script {
                        // ì´ë¯¸ì§€ ì •ë³´ íŒŒì‹±
                        def dockerfilePath = params.DOCKERFILE_PATH
                        def pathParts = dockerfilePath.split('/')
                        def imageName = "${pathParts[0]}/${pathParts[1]}"  // apache/airflow
                        def imageVersion = pathParts[2]  // 3.1.1
                        def branchTag = params.BRANCH_NAME.replaceAll('/', '-')
                        
                        // ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ (Dockerfileì´ ìˆëŠ” ë””ë ‰í† ë¦¬)
                        def dockerfileDir = dockerfilePath.substring(0, dockerfilePath.lastIndexOf('/'))
                        
                        echo "Building: ${NEXUS_REGISTRY}/${imageName}:${imageVersion}-${branchTag}"
                        
                        sh """
                            /kaniko/executor \
                              --context=\${WORKSPACE}/${dockerfileDir} \
                              --dockerfile=\${WORKSPACE}/${dockerfilePath} \
                              --destination=${NEXUS_REGISTRY}/${imageName}:${imageVersion}-${branchTag} \
                              --destination=${NEXUS_REGISTRY}/${imageName}:latest \
                              --cache=true \
                              --cache-repo=${NEXUS_REGISTRY}/${imageName}/cache \
                              --skip-tls-verify \
                              --registry-mirror=${NEXUS_REGISTRY} \
                              --insecure-registry=${NEXUS_REGISTRY}
                        """
                        
                        echo "âœ… Image pushed successfully!"
                        echo "   - ${NEXUS_REGISTRY}/${imageName}:${imageVersion}-${branchTag}"
                        echo "   - ${NEXUS_REGISTRY}/${imageName}:latest"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ Pipeline completed successfully!"
        }
        failure {
            echo "âŒ Pipeline failed!"
        }
        always {
            cleanWs()
        }
    }
}